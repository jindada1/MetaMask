<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/metamask-fox.svg" alt="img" style="zoom:500%;" />

以下是本引导课程的内容大纲，本次实验内容涉及下图中白色线框标注的部分，线上实验网站的链接：http://210.22.77.126:11001/

![mind mapping](MetaMask%20%E5%AE%9E%E9%AA%8C/mind%20mapping.jpg)



**注：实验平台的 UI 会不定期的更新，因此本教程中的截图和实际界面的样式可能会不一致。但整体操作步骤和实验流程不会改变**



## 连接

连接我们的测试链

![image-20220629171139057](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629171139057.png)

选择 **连接站点和METAMASK** 按钮，MetaMask 插件会弹窗

| 步骤一                                                       | 步骤二                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 点击 **下一步**                                              | 点击 **连接**                                                |
| <img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629171411815.png" alt="image-20220629171411815"/> | <img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629171532768.png" alt="image-20220629171532768"/> |

等待一段时间连接成功后，可以在实验平台上看到账户信息

![image-20220629171930308](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629171930308.png)

> 可以看到这里的账户公钥和我们在 MetaMask 中的地址是一致的

![image-20220629172135749](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629172135749.png)

```
点击 ETH_ACCOUNTS 按钮看看会发生什么？
```



## 权限

**请确保已添加测试链网络**

![image-20220629172459765](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629172459765.png)

选择 **申请权限** 按钮，MetaMask 插件会弹窗

| 步骤一                                                       | 步骤二                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 点击 **下一步**                                              | 点击 **连接**                                                |
| ![image-20220629172629382](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629172629382.png) | ![image-20220629172710124](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629172710124.png) |

等待一段时间连接成功后，可以在实验平台上看到权限信息

![image-20220629172852963](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629172852963.png)



## 链管理

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630100031268.png" style="zoom:80%;" />

点击 **添加 FDU 2022 SUMMER**，MetaMask 插件会弹窗

| 步骤一                                                       | 步骤二                                                       |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 点击 **允许**                                                | 点击 **切换网络**                                            |
| ![image-20220630100425902](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630100425902.png) | ![image-20220630100525910](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630100525910.png) |

此时已经切换到FDU 2022 SUMMER网络，若要切换至以太坊主网，可以点击 **切换至以太坊主网** 按钮，MetaMask 插件会弹窗

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630100740450.png" style="zoom:50%;" />

点击 **切换网络**，则切换至以太坊主网。若想切换回FDU 2022 SUMMER，只需点击 **切换至FDU 2022 SUMMER** 按钮

MateMask 会出现弹窗，我们点击 **批准** 按钮，等待一段时间后

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630142942735.png" alt="image-20220630142942735" style="zoom:50%;" />

即可在 MetaMask 界面看到新增的用于本课程的网络

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630145247969.png" alt="image-20220630145247969" style="zoom: 67%;" />

## 申请代币

点击 **申请 100 DAN**，这个操作会从 **代币金库** 转移 100 个 DAN 到你的账户

![image-20220629173403250](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629173403250.png)

可以看到下方会出现一串蓝色的交易哈希（蓝色文字代表是超链接）

![image-20220629173505809](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629173505809.png)

点击 [这个哈希](http://210.22.77.126:10084/tx/0x1d7edd22d69fb5904b690d2b268a92843a7d6bb1acd9b02aca45b9cc8d8a92a7) 即可在区块链浏览器中查看交易的详细信息，截图如下

![image-20220629173832026](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629173832026.png)

在这里重点关注 From 和 To 两个字段：

+ From 的值为代币金库的地址
+ To 为你账户的地址



## 发送代币

点击 **发送 10 DAN**，这个操作会从你的账户转移 10 个 DAN 到 **目标账户** 

![image-20220629175229049](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629175229049.png)

MetaMask 插件会弹窗，在弹窗中可以看到此次交易的基本信息，点击**确认**：

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629175900990.png" alt="image-20220629175900990" style="zoom:50%;" />

点完之后不会有界面不会有提示，我们可以点击下图中标注的目标账户的地址

![image-20220629180421006](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629180421006.png)

即可在区块链浏览器中查看该账户的[详细信息](http://210.22.77.126:10084/address/0x1B721C66C6f32429A821B99866de0231e34FEB6D/transactions)，在页面中的 Transactions 部分可以看到该账户（地址）相关的交易列表，刚刚发起的转账交易就在列表的最上方（下图中黑色线框标注的）。

![image-20220629180621046](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629180621046.png)

我们注意这条交易的状态是 Pending，代表交易还未确认，需要等待一段时间后，状态会更新成Success

![image-20220629181002439](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629181002439.png)

点击这一条交易的地址，跳转到该交易的[详细信息](http://210.22.77.126:10084/tx/0x35290164250fbd6d30bb3792f01eeaf4346334624468bd74184a73b0096130d5)页面

![image-20220629181145085](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629181145085.png)

同样的，我们关注 From 和 To 两个字段：

+ From 的值你账户的地址
+ To 为**目标账户**的地址



## 合约

![image-20220629181333690](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629181333690.png)

### 部署

点击 **部署智能合约**，MetaMask 弹窗。

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629181429522.png" alt="image-20220629181429522" style="zoom:50%;" />

弹窗中可以浏览此次交易的基本信息，点击 **确认**，我们可以看到合约的状态更新为 “部署中”（下图）

![image-20220629181741498](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629181741498.png)

等待一段时间后，状态更新为 “已部署”

![image-20220629182000502](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629182000502.png)

我们可以将页面滚动到上方账户信息卡片，点击我们的账户地址

![image-20220629182154760](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629182154760.png)

就可以进入区块链浏览器，查看账户[详细信息](http://210.22.77.126:10084/address/0xE61E4C20E63896F88670fBBBAeD3518b09eCB186/transactions)。

![image-20220629182311878](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629182311878.png)

在交易列表中查看最上方的交易，我们就是通过这个交易来部署此次智能合约，点击这一条交易的地址，跳转到该交易的[详细信息](http://210.22.77.126:10084/tx/0xd44e2a7b6f9ac889c725df69310330fc60fe842bca85da443df9baa8d4b5e7ce)页面（下图）。

![image-20220629182609078](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629182609078.png)

```
可以自己分析一下这里 From 和 To 字段的含义
```

### 存入

点击 **存入合约 4 DAN**，MetaMask 弹窗。

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629183346830.png" alt="image-20220629183346830" style="zoom:50%;" />

我们进入合约的[地址详情页](http://210.22.77.126:10084/address/0x263dB940cE7D324e3A09e12C7c6AC20A306F4080/transactions)，可以看到刚才的交易还处在 Pending 状态（如下图所示）：

> 可以在上一步部署合约的交易里，找到合约的地址，点击即可进入合约的地址详情页

![image-20220629183426968](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629183426968.png)

等待交易确认（Success）后，刷新页面，可以看到合约的余额为 4 DAN

![image-20220629183744303](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629183744303.png)

### 取出

取出的过程和存入过程的相似

```
可以自己试试
```



## 自定义代币

### 发送给同学

![image-20220629221531887](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629221531887.png)

我们可以将同学的账户地址填入 **接受账户** 字段，在数据字段填写自定义的字符串（test）

点击 **提交** 后，MateMask 弹窗，点击**确认**

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629221710730.png" alt="image-20220629221710730" style="zoom:50%;" />

随后就可以在页面上看到此次交易的哈希（如下图所示）

![image-20220629221831284](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629221831284.png)

点击即可查看交易[详细信息](http://210.22.77.126:10084/tx/0x38f6ff585b6f1a4cf221b2ee093d83700ba1f3ea67134baba70e3c3435e157c0) （下图所示）

![image-20220629222328828](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629222328828.png)

这里我们可以关注下方的 `Raw Input` 字段，我们点击这里的下拉框，选择 `UTF-8`，即可在下方的文本框内看到我们在发送交易时输入的字符串（test）

我们也可以点击 `To` 字段的地址查看[接收账户的详细信息](http://210.22.77.126:10084/address/0x1B721C66C6f32429A821B99866de0231e34FEB6D/transactions)。

### 创建

![image-20220629222913005](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629222913005.png)

我们通过部署代币合约的方式来创建自定义代币，点击**部署合约**，查看弹窗信息后，点击**确认**

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629223049386.png" alt="image-20220629223049386" style="zoom:50%;" />

等待一段时间后，页面上会出现此次合约的地址

![image-20220629223221374](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629223221374.png)

这个地址是纯文本，不是超链接，可以按照以下规则拼接 URL 访问

`http://210.22.77.126:10084/address/[hash]/transactions`

将合约地址填到 `[hash]` 这个位置即可，比如

`http://210.22.77.126:10084/address/0x115aacCBA727A189ef24E27dbbfFCeef34e42020/transactions`

用浏览器访问该 URL 即可查看该地址的[详细信息](http://210.22.77.126:10084/address/0x115aacCBA727A189ef24E27dbbfFCeef34e42020/transactions)。

### 添加代币

点击 **把代币添加至钱包**，在 MateMask 弹窗中可以看到这个代币的基本信息

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629223755810.png" alt="image-20220629223755810" style="zoom:50%;" />

我们点击 **添加** 按钮，之后回到 MetaMask 中查看账户信息，可以看到我们刚添加的代币（如下图）

![image-20220629223932055](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629223932055.png)

补充：我们点击 **活动** 标签页，可以看到这个账户的所有操作（发送的交易）

![image-20220629224105287](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629224105287.png)

### 发送代币

```
这一步的操作和之前一样，大家可以自己试一试，看看交易详情以及交易双方的余额变动
```

### 授权代币

点击 **授权代币**，在 MateMask 弹窗中点击 **确认** 即可

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629224500369.png" alt="image-20220629224500369" style="zoom:50%;" />

## NFT

![image-20220629224636961](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629224636961.png)

### 部署

点击 **部署NFT合约**，确认弹窗信息后，点击 **确认**。

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629224918522.png" alt="image-20220629224918522" style="zoom:50%;" />

等待一段时间后，页面上会出现此次合约的地址

![image-20220629225055284](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629225055284.png)

我们进入我们自己的[账户信息页](http://210.22.77.126:10084/address/0xE61E4C20E63896F88670fBBBAeD3518b09eCB186/transactions)，可以在交易列表中找到这次用于部署合约的交易

![image-20220629225437811](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629225437811.png)

### 铸币

点击 **铸币（MINT）**，确认弹窗信息后，点击 **确认**。

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629225156812.png" alt="image-20220629225156812" style="zoom:50%;" />

等待一段时间后，状态变成 “铸币完成”

![image-20220629225629326](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629225629326.png)

此时回到刚才的自己的[账户信息页](http://210.22.77.126:10084/address/0xE61E4C20E63896F88670fBBBAeD3518b09eCB186/transactions)，在交易列表中找到刚才的铸币交易，可以看到这笔交易的类型是 `Contract Call`（下图灰色箭头）

![image-20220629225726135](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220629225726135.png)



## 加密/解密

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630101416183.png" style="zoom:80%;" />



### 获取加密公钥

点击 **获取加密公钥**，在MetaMask弹窗中点击 **提供**，则会把我们账户的公钥提供给网站

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630101541863.png" style="zoom:50%;" />

可以看到页面上出现了我们的加密公钥

![image-20220630101747410](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630101747410.png)

我们可以在待加密信息中输入任何信息，然后点击 **加密**

![image-20220630102002725](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630102002725.png)

页面上显示了用我们的加密公钥加密消息后得到的密文

![image-20220630102107939](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630102107939.png)

点击 **解密**，在MetaMask弹窗中点击 **解密**，则可以用我们的私钥来解密信息

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630102314362.png" style="zoom:50%;" />

可以看到页面显示的解密后的原文与我们之前提供的信息相同

![image-20220630102715128](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630102715128.png)



## 签名

### 消息签名

#### Eth Sign

![image-20220630103306436](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630103306436.png)

点击 **签名**，在MetaMask的弹窗中点击 **签名**，则可以用私钥对消息进行签名

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630103357315.png" style="zoom:50%;" />

可以看到在页面上显示了签名后的结果

![image-20220630103557641](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630103557641.png)

> eth_sign 可以用来签署任意数据。这使得它是最强大的，最简单的（只是签署数据），但也是最危险的。这里的问题是，你可以让用户签署一个数据，而这个实际上是交易数据。想象一下，你让用户登录到你的服务，但你让他们签署的数据实际上是一个交易，如 "发送5个ETH给攻击者"。交易毕竟只是由字节组成，人们很可能不会检查他们所签署的这串字符的实际含义。看似无害的签名，却成了窃取资金的攻击。
所以 MetaMask 不建议用户使用此方法，会出现红色的提示消息来警告用户。



#### Personal Sign

![image-20220630104255880](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630104255880.png)

点击 **签名**，在MetaMask的弹窗中点击 **签名**，则可以用私钥对消息进行签名，可以看到消息内容为：‘personal_sign’示例消息

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630104404795.png" style="zoom:50%;" />

可以看到在页面上显示了签名后的结果

![image-20220630104539937](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630104539937.png)

点击验证可以看到两种验证方式的结果都为我们的账户地址

使用 `eth-sig-util` 中的 `recovery` 方法或`personal_ecRecover`方法都可以从签名中提取签名私钥对应的以太坊地址。

![image-20220630104625577](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630104625577.png)

![image-20220630104940103](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630104940103.png)


> personal_sign 方法在任何签名数据前加上"\x19Ethereum Signed Message:\n"，这意味着如果有人要签署交易数据，添加的前缀字符串会使其成为无效交易。
同时这种方法在UTF-8编码时能够显示可读的文本，主要用于实现用户登录功能。
文本前缀使得这些签名在链上的验证成本很高

### 结构化数据签名

![image-20220630212430111](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630212430111.png)

我们看到待签名的信息是结构化的一组数据，点击 **签名** 按钮，MetaMask 弹窗提示

核对信息无误后，点击 **向下的箭头**（下图中红色箭头所指）后，**签名** 按钮会亮起，点击 **签名** 按钮

<img src="MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630212736555.png" alt="image-20220630212736555" style="zoom:70%;" />

页面上会展示此次签名的结果（如下图所示）

![image-20220630212922239](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630212922239.png)

随后点击 **验证** 按钮，便可以在下方看到签名人的地址

![image-20220630213102976](MetaMask%20%E5%AE%9E%E9%AA%8C/image-20220630213102976.png)